---
import Layout from '@/layouts/Layout.astro'
import ListingHero from '@/components/listing-hero.astro'
---

<Layout title="Badge++" description="Bluetooth text controller for Badger 2350">
  <ListingHero
    eyebrow="// BLUETOOTH CLIENT"
    title="Badge"
    titleHighlight="++"
    description="Wire text to your badge via Bluetooth LE. Connect and transmit messages directly to the badge2 app."
  />

  <section class="container pb-20">
    <div class="max-w-3xl mx-auto space-y-8">
      <!-- Connection Status -->
      <article class="rounded-lg border border-border/40 bg-layer-mid/60 p-6 shadow-sm">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div id="status-indicator" class="h-3 w-3 rounded-full bg-muted-foreground/40"></div>
            <span id="connection-status" class="font-mono text-sm uppercase tracking-[0.14em] text-muted-foreground">
              Disconnected
            </span>
          </div>
          <button
            id="connect-btn"
            class="px-4 py-2 border border-border/40 rounded font-mono text-sm uppercase tracking-[0.12em] text-foreground hover:text-primary hover:bg-primary/10 hover:border-primary/60 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Connect Badge
          </button>
        </div>
      </article>

      <!-- Password Input -->
      <article class="rounded-lg border border-border/40 bg-layer-mid/60 p-8 shadow-sm">
        <div class="space-y-4">
          <div>
            <label 
              for="password-input" 
              class="block font-mono text-sm uppercase tracking-[0.14em] text-primary mb-3"
            >
              Badge Password
            </label>
            <input
              type="text"
              id="password-input"
              class="w-full px-4 py-3 bg-background border border-border/40 rounded font-mono text-base text-foreground placeholder:text-muted-foreground focus:outline-none focus:border-primary/60 focus:ring-1 focus:ring-primary/30 transition-all uppercase"
              placeholder="A7K2"
              maxlength="4"
              value=""
            />
          </div>
          <div class="flex items-start gap-3 pt-2">
            <div class="font-mono text-xs text-muted-foreground leading-relaxed">
              Enter 4-character password displayed on badge screen. Password proves physical possession and is required for all writes. Not transmitted via Bluetooth.
            </div>
          </div>
        </div>
      </article>

      <!-- Text Input -->
      <article class="rounded-lg border border-border/40 bg-layer-mid/60 p-8 shadow-sm">
        <div class="space-y-6">
          <div>
            <label 
              for="badge-input" 
              class="block font-mono text-sm uppercase tracking-[0.14em] text-primary mb-3"
            >
              Message Text
            </label>
            <input
              type="text"
              id="badge-input"
              class="w-full px-4 py-3 bg-background border border-border/40 rounded font-mono text-base text-foreground placeholder:text-muted-foreground focus:outline-none focus:border-primary/60 focus:ring-1 focus:ring-primary/30 transition-all disabled:opacity-50"
              placeholder="Type message for badge..."
              maxlength="100"
              disabled
            />
          </div>
          
          <button
            id="send-btn"
            class="w-full px-4 py-3 border border-border/40 rounded font-mono text-base uppercase tracking-[0.12em] text-foreground hover:text-primary hover:bg-primary/10 hover:border-primary/60 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
            disabled
          >
            Transmit to Badge
          </button>

          <div class="pt-4 border-t border-border/30">
            <div class="font-mono text-xs uppercase tracking-[0.14em] text-muted-foreground mb-3">
              Badge Current Text
            </div>
            <div 
              id="current-text" 
              class="min-h-[80px] p-4 bg-background border border-border/40 rounded font-mono text-base text-foreground break-words"
            >
              <span class="text-muted-foreground">--</span>
            </div>
          </div>
        </div>
      </article>

      <!-- Log Output -->
      <article class="rounded-lg border border-border/40 bg-layer-mid/60 p-6 shadow-sm">
        <div class="font-mono text-xs uppercase tracking-[0.14em] text-muted-foreground mb-3">
          Connection Log
        </div>
        <div 
          id="log-output" 
          class="min-h-[120px] max-h-[300px] overflow-y-auto p-4 bg-background border border-border/40 rounded font-mono text-xs text-muted-foreground space-y-1"
        >
          <div class="text-muted-foreground/60">System ready. Click Connect Badge to begin.</div>
        </div>
      </article>

      <div class="text-center space-y-2">
        <p class="font-mono text-sm text-muted-foreground">
          Service UUID: 12345678-1234-5678-1234-56789abcdef0
        </p>
        <p class="font-mono text-sm text-muted-foreground">
          Text Char: 12345678-1234-5678-1234-56789abcdef1
        </p>
        <p class="font-mono text-xs text-muted-foreground/60">
          Requires Web Bluetooth API · Chrome/Edge recommended
        </p>
        <p class="font-mono text-xs text-muted-foreground/60">
          Physical badge access required · Password not transmitted via BT
        </p>
      </div>
    </div>
  </section>

  <script>
    // Bluetooth Service and Characteristic UUIDs
    const SERVICE_UUID = '12345678-1234-5678-1234-56789abcdef0'
    const TEXT_CHAR_UUID = '12345678-1234-5678-1234-56789abcdef1'
    const DEVICE_NAME = 'badge2-text'

    // UI Elements
    const connectBtn = document.getElementById('connect-btn') as HTMLButtonElement
    const sendBtn = document.getElementById('send-btn') as HTMLButtonElement
    const input = document.getElementById('badge-input') as HTMLInputElement
    const passwordInput = document.getElementById('password-input') as HTMLInputElement
    const currentText = document.getElementById('current-text') as HTMLElement
    const statusIndicator = document.getElementById('status-indicator') as HTMLElement
    const connectionStatus = document.getElementById('connection-status') as HTMLElement
    const logOutput = document.getElementById('log-output') as HTMLElement

    // State
    let device: BluetoothDevice | null = null
    let textCharacteristic: BluetoothRemoteGATTCharacteristic | null = null
    let isConnected = false

    // Check for password in URL params (from QR code scan)
    const urlParams = new URLSearchParams(window.location.search)
    const urlPassword = urlParams.get('password')
    if (urlPassword) {
      passwordInput.value = urlPassword.toUpperCase()
      log(`Password loaded from QR code: ${urlPassword}`, 'success')
    }

    // Auto-uppercase password input
    passwordInput.addEventListener('input', () => {
      passwordInput.value = passwordInput.value.toUpperCase()
    })

    // Logging
    function log(message: string, type: 'info' | 'success' | 'error' = 'info') {
      const timestamp = new Date().toLocaleTimeString()
      const colorClass = type === 'success' ? 'text-primary' : type === 'error' ? 'text-red-400' : 'text-muted-foreground'
      const entry = document.createElement('div')
      entry.className = colorClass
      entry.textContent = `[${timestamp}] ${message}`
      logOutput.appendChild(entry)
      logOutput.scrollTop = logOutput.scrollHeight
    }

    // Update UI state
    function updateConnectionState(connected: boolean) {
      isConnected = connected
      
      if (connected) {
        statusIndicator.className = 'h-3 w-3 rounded-full bg-primary shadow-[0_0_8px_rgba(95,237,131,0.6)]'
        connectionStatus.textContent = 'Connected'
        connectionStatus.className = 'font-mono text-sm uppercase tracking-[0.14em] text-primary'
        connectBtn.textContent = 'Disconnect'
        input.disabled = false
        sendBtn.disabled = false
      } else {
        statusIndicator.className = 'h-3 w-3 rounded-full bg-muted-foreground/40'
        connectionStatus.textContent = 'Disconnected'
        connectionStatus.className = 'font-mono text-sm uppercase tracking-[0.14em] text-muted-foreground'
        connectBtn.textContent = 'Connect Badge'
        input.disabled = true
        sendBtn.disabled = true
        currentText.innerHTML = '<span class="text-muted-foreground">--</span>'
      }
    }

    // Check Web Bluetooth support
    if (!navigator.bluetooth) {
      log('Web Bluetooth API not available. Use Chrome or Edge.', 'error')
      connectBtn.disabled = true
      connectBtn.textContent = 'BT Unavailable'
    }

    // Connect to badge
    async function connectToBadge() {
      try {
        log('Scanning for badge2-text...')
        
        // Request device
        device = await navigator.bluetooth.requestDevice({
          filters: [{ name: DEVICE_NAME }],
          optionalServices: [SERVICE_UUID]
        })

        log(`Found device: ${device.name}`)

        // Set up disconnect handler
        device.addEventListener('gattserverdisconnected', () => {
          log('Device disconnected', 'error')
          updateConnectionState(false)
          textCharacteristic = null
        })

        // Connect to GATT server
        log('Connecting to GATT server...')
        const server = await device.gatt!.connect()
        log('GATT server connected', 'success')

        // Get service
        log('Discovering text service...')
        const service = await server.getPrimaryService(SERVICE_UUID)
        log('Service discovered', 'success')

        // Get text characteristic
        log('Getting text characteristic...')
        textCharacteristic = await service.getCharacteristic(TEXT_CHAR_UUID)
        log('Text characteristic ready', 'success')

        // Read current text
        await readCurrentText()

        updateConnectionState(true)
        log('Connection established', 'success')
        
        // Remind user to enter password if not already provided
        if (!passwordInput.value.trim()) {
          log('Enter password from badge screen to transmit text', 'info')
        }

      } catch (error) {
        log(`Connection error: ${error}`, 'error')
        updateConnectionState(false)
      }
    }

    // Disconnect from badge
    async function disconnectFromBadge() {
      if (device && device.gatt?.connected) {
        device.gatt.disconnect()
        log('Disconnected from badge')
      }
      updateConnectionState(false)
      textCharacteristic = null
      device = null
    }

    // Read current text from badge
    async function readCurrentText() {
      if (!textCharacteristic) {
        log('No text characteristic available', 'error')
        return
      }

      try {
        log('Reading current text from badge...')
        const value = await textCharacteristic.readValue()
        const text = new TextDecoder().decode(value)
        currentText.textContent = text || '--'
        currentText.className = 'min-h-[80px] p-4 bg-background border border-border/40 rounded font-mono text-base text-foreground break-words'
        log(`Current text: "${text}"`, 'info')
      } catch (error) {
        log(`Read error: ${error}`, 'error')
      }
    }

    // Send text to badge
    async function sendTextToBadge() {
      if (!textCharacteristic) {
        log('Not connected to badge', 'error')
        return
      }

      const inputText = input.value.trim()
      if (!inputText) {
        log('No text to send', 'error')
        return
      }

      const password = passwordInput.value.trim()
      if (!password) {
        log('Password required. Read from badge screen.', 'error')
        return
      }

      if (password.length !== 4) {
        log('Password must be exactly 4 characters', 'error')
        return
      }

      try {
        log(`Transmitting authenticated message...`)
        
        // Prepare authenticated payload with user-provided password
        // Password proves physical possession of badge (read from screen)
        const payload = {
          password: password,
          text: inputText
        }
        
        const encoder = new TextEncoder()
        const data = encoder.encode(JSON.stringify(payload))
        
        // Check payload size and log warning if potentially too large
        // BLE default MTU is 23 bytes (20 payload + 3 header), though many devices support more
        log(`Payload size: ${data.length} bytes`, 'info')
        
        // Use writeValueWithResponse for reliability with longer payloads
        // This ensures the write completes even if it requires multiple packets
        await textCharacteristic.writeValueWithResponse(data)
        log('Text transmitted successfully', 'success')

        // Read back to confirm
        await readCurrentText()

        // Clear input
        input.value = ''

      } catch (error) {
        log(`Transmission error: ${error}`, 'error')
        log('Verify password matches badge screen', 'error')
      }
    }

    // Event listeners
    connectBtn.addEventListener('click', async () => {
      if (isConnected) {
        await disconnectFromBadge()
      } else {
        await connectToBadge()
      }
    })

    sendBtn.addEventListener('click', async () => {
      await sendTextToBadge()
    })

    // Send on Enter key
    input.addEventListener('keypress', async (e) => {
      if (e.key === 'Enter' && isConnected) {
        await sendTextToBadge()
      }
    })
  </script>
</Layout>
